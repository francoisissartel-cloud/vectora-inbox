# .q-context/blueprint-v2-current.yaml
# Blueprint Vectora Inbox V2 - Architecture 3 Lambdas Valid√©e
# Refl√®te l'√©tat r√©el du syst√®me apr√®s stabilisation (18 d√©cembre 2025)
#
# Bas√© sur :
# - docs/diagnostics/src_v2_hygiene_audit_v2.md (conformit√© 100% valid√©e)
# - docs/design/vectora_inbox_v2_engine_overview.md (architecture document√©e)
# - docs/design/vectora_inbox_v2_bedrock_calls_map_lai_weekly_v3.md (appels valid√©s)
# - Validation E2E sur lai_weekly_v3 (15 items r√©els trait√©s avec succ√®s)

project:
  name: "Vectora Inbox V2"
  description: "Moteur d'intelligence sectorielle automatis√©e - Architecture 3 Lambdas stabilis√©e"
  aws_profile: "rag-lai-prod"
  aws_account_id: "786469175371"
  region: "eu-west-3"
  envs:
    - "dev"

bedrock:
  region: "us-east-1"  # R√©gion valid√©e E2E
  usage: "Cerveau linguistique pour normalisation (extraction entit√©s, classification √©v√©nements) et g√©n√©ration √©ditoriale"
  default_model: "anthropic.claude-3-sonnet-20240229-v1:0"  # Mod√®le valid√© E2E
  models:
    normalize: "anthropic.claude-3-sonnet-20240229-v1:0"
    matching: "anthropic.claude-3-sonnet-20240229-v1:0"
    editorial: "anthropic.claude-3-sonnet-20240229-v1:0"
  performance_validated:
    calls_per_run: 30  # 15 normalisation + 15 matching (lai_weekly_v3)
    avg_time_per_call: "5.4s"
    success_rate: "100%"
    cost_per_run: "$0.21"
  notes:
    - "Mod√®le Claude Sonnet 3 valid√© sur 15 items LAI r√©els"
    - "30 appels Bedrock par run lai_weekly_v3 (normalisation + matching s√©mantique)"
    - "Performance : 163s total, 100% succ√®s, $0.21/run"
    - "Bedrock IS used for: entity extraction, event classification, semantic domain matching, newsletter writing"
    - "Bedrock is NOT used for: HTTP requests, RSS parsing, deterministic scoring"
    - "Prompts canonicalis√©s dans canonical/prompts/global_prompts.yaml"

naming:
  resource_prefix: "vectora-inbox"
  stack_prefix: "vectora-inbox"
  version_suffix: "-v2"
  env_suffix: "-dev"
  stacks:
    - "s0-core"      # Core S3 buckets
    - "s0-iam"       # IAM roles s√©par√©s
    - "s1-runtime"   # 3 Lambdas V2

repo_layout:
  root: "vectora-inbox/"
  code_reference: "src_v2/"  # Source of truth valid√©e
  folders:
    - path: "src_v2/"
      purpose: "Code de r√©f√©rence - Architecture 3 Lambdas V2 conforme aux r√®gles d'hygi√®ne V4"
      structure:
        - "lambdas/ingest/handler.py"
        - "lambdas/normalize_score/handler.py" 
        - "lambdas/newsletter/handler.py"
        - "vectora_core/ (modules m√©tier r√©utilisables)"
    - path: "canonical/"
      purpose: "Scopes m√©tier et prompts canonicalis√©s - pilotent le comportement"
    - path: "client-config-examples/"
      purpose: "Configurations client (lai_weekly_v3.yaml valid√©)"
    - path: "contracts/"
      purpose: "Contrats m√©tier synchronis√©s avec le code r√©el"
    - path: "docs/design/"
      purpose: "Documentation architecture V2 stabilis√©e"

infra_stacks:
  s0-core:
    description: "Buckets S3 core valid√©s"
    requirements:
      region: "eu-west-3"
      profile: "rag-lai-prod"
    resources:
      s3_buckets:
        - id: "config_bucket"
          name: "vectora-inbox-config-dev"
          purpose: "Configurations client + canonical (scopes, prompts)"
        - id: "data_bucket"
          name: "vectora-inbox-data-dev"
          purpose: >
            Donn√©es de traitement avec structure V2 valid√©e:
            
            Ingested layer (sortie ingest-v2):
              ingested/<client_id>/<YYYY>/<MM>/<DD>/items.json
              - Items pars√©s depuis sources externes
              - Exemple valid√©: ingested/lai_weekly_v3/2025/12/17/items.json (15 items)
            
            Curated layer (sortie normalize-score-v2):
              curated/<client_id>/<YYYY>/<MM>/<DD>/items.json
              - Items normalis√©s, match√©s et scor√©s
              - Pr√™ts pour g√©n√©ration newsletter
            
            Raw layer (optionnel, debug):
              raw/<client_id>/<source_key>/<YYYY>/<MM>/<DD>/raw.json
        - id: "newsletters_bucket"
          name: "vectora-inbox-newsletters-dev"
          purpose: "Newsletters finales g√©n√©r√©es (Markdown/HTML)"

  s0-iam:
    description: "R√¥les IAM pour les 3 Lambdas V2"
    requirements:
      region: "eu-west-3"
      profile: "rag-lai-prod"
    resources:
      iam_roles:
        - id: "ingest_role"
          name: "vectora-inbox-ingest-v2-role"
          permissions:
            - "s3:GetObject on vectora-inbox-config-dev/*"
            - "s3:PutObject on vectora-inbox-data-dev/ingested/*"
            - "s3:PutObject on vectora-inbox-data-dev/raw/*"
        - id: "normalize_score_role"
          name: "vectora-inbox-normalize-score-v2-role"
          permissions:
            - "s3:GetObject on vectora-inbox-config-dev/*"
            - "s3:GetObject on vectora-inbox-data-dev/ingested/*"
            - "s3:PutObject on vectora-inbox-data-dev/curated/*"
            - "bedrock:InvokeModel"
        - id: "newsletter_role"
          name: "vectora-inbox-newsletter-v2-role"
          permissions:
            - "s3:GetObject on vectora-inbox-config-dev/*"
            - "s3:GetObject on vectora-inbox-data-dev/curated/*"
            - "s3:PutObject on vectora-inbox-newsletters-dev/*"
            - "bedrock:InvokeModel"

  s1-runtime:
    description: "3 Lambdas V2 - Architecture modulaire valid√©e"
    requirements:
      region: "eu-west-3"
      profile: "rag-lai-prod"
    resources:
      lambda_layers:
        - id: "vectora_core_layer"
          name: "vectora-inbox-vectora-core-dev"
          content: "src_v2/vectora_core/ (modules m√©tier)"
          size: "180KB"
        - id: "common_deps_layer"
          name: "vectora-inbox-common-deps-dev"
          content: "PyYAML, requests, boto3, feedparser (mode pur Python)"
          size: "15MB"
      
      lambdas:
        - id: "ingest_lambda_v2"
          name: "vectora-inbox-ingest-v2-dev"
          runtime: "python3.11"
          handler: "src_v2/lambdas/ingest/handler.py::lambda_handler"
          orchestration_function: "vectora_core.ingest.run_ingest_for_client"
          needs_bedrock: false
          size: "15KB"
          environment_variables:
            - "ENV=dev"
            - "CONFIG_BUCKET=vectora-inbox-config-dev"
            - "DATA_BUCKET=vectora-inbox-data-dev"
            - "LOG_LEVEL=INFO"
          phases:
            - "Ingestion brute depuis sources externes (RSS, APIs, scraping)"
            - "Parsing en items structur√©s"
            - "Stockage dans S3 ingested/"
          validation_status: "‚úÖ Fonctionnel - Valid√© E2E sur lai_weekly_v3"

        - id: "normalize_score_lambda_v2"
          name: "vectora-inbox-normalize-score-v2-dev"
          runtime: "python3.11"
          handler: "src_v2/lambdas/normalize_score/handler.py::lambda_handler"
          orchestration_function: "vectora_core.normalization.run_normalize_score_for_client"
          needs_bedrock: true
          size: "18KB"
          environment_variables:
            - "ENV=dev"
            - "CONFIG_BUCKET=vectora-inbox-config-dev"
            - "DATA_BUCKET=vectora-inbox-data-dev"
            - "BEDROCK_MODEL_ID=anthropic.claude-3-sonnet-20240229-v1:0"
            - "BEDROCK_REGION=us-east-1"
            - "MAX_BEDROCK_WORKERS=1"
            - "LOG_LEVEL=INFO"
          phases:
            - "Normalisation Bedrock (extraction entit√©s, classification √©v√©nements)"
            - "Matching s√©mantique Bedrock aux domaines de veille"
            - "Scoring d√©terministe bas√© sur r√®gles m√©tier"
            - "Stockage dans S3 curated/"
          validation_status: "‚úÖ Fonctionnel - 15 items trait√©s, 30 appels Bedrock, 100% succ√®s"

        - id: "newsletter_lambda_v2"
          name: "vectora-inbox-newsletter-v2-dev"
          runtime: "python3.11"
          handler: "src_v2/lambdas/newsletter/handler.py::lambda_handler"
          orchestration_function: "vectora_core.newsletter.run_newsletter_for_client"
          needs_bedrock: true
          size: "12KB"
          environment_variables:
            - "ENV=dev"
            - "CONFIG_BUCKET=vectora-inbox-config-dev"
            - "DATA_BUCKET=vectora-inbox-data-dev"
            - "NEWSLETTERS_BUCKET=vectora-inbox-newsletters-dev"
            - "BEDROCK_MODEL_ID=anthropic.claude-3-sonnet-20240229-v1:0"
            - "BEDROCK_REGION=us-east-1"
            - "LOG_LEVEL=INFO"
          phases:
            - "Lecture items cur√©s depuis S3"
            - "G√©n√©ration √©ditoriale Bedrock par section"
            - "Assemblage newsletter finale (Markdown)"
            - "Stockage dans S3 newsletters/"
          validation_status: "üöß Structure pr√™te - Impl√©mentation √† compl√©ter"

# Configuration pilot√©e (client_config + canonical)
configuration_driven:
  client_config_example: "lai_weekly_v3.yaml"
  client_config_controls:
    - "Sources d'ingestion (bouquets + sources individuelles)"
    - "Domaines de veille (watch_domains avec scopes)"
    - "Seuils de matching (min_domain_score, fallback_mode)"
    - "Bonus de scoring (pure_player_companies, trademark_mentions)"
    - "Structure newsletter (sections, max_items, filtres)"
    - "Fen√™tre temporelle (default_period_days)"
  
  canonical_controls:
    - "Scopes m√©tier (companies, molecules, technologies, trademarks)"
    - "Prompts Bedrock (normalisation, matching, √©ditorial)"
    - "R√®gles de scoring (poids par type d'√©v√©nement)"
    - "Catalogues de sources (180+ sources, bouquets pr√©d√©finis)"
  
  no_code_changes_required:
    - "Ajustement seuils de matching"
    - "Modification bonus de scoring"
    - "Restructuration newsletter"
    - "Ajout nouvelles entit√©s m√©tier"
    - "Modification prompts Bedrock"

# Validation E2E
validation_e2e:
  client_reference: "lai_weekly_v3"
  last_validation: "2025-12-18"
  results:
    items_processed: 15
    sources_active: 8
    entities_extracted: 36
    bedrock_calls: 30
    execution_time: "163s"
    success_rate: "100%"
    cost_per_run: "$0.21"
    synthetic_data_eliminated: true
  
  data_flow_validated:
    - "Sources externes ‚Üí S3 ingested/ (15 items LAI r√©els)"
    - "S3 ingested/ ‚Üí Bedrock ‚Üí S3 curated/ (normalisation + matching)"
    - "Configuration lai_weekly_v3.yaml appliqu√©e correctement"
    - "Entit√©s LAI extraites : MedinCell, UZEDY¬Æ, Nanexa, BEPO, etc."

# Conformit√© et bonnes pratiques
compliance:
  hygiene_rules: "src_lambda_hygiene_v4.md"
  compliance_score: "100%"
  violations: "Aucune"
  
  architecture_principles:
    - "3 Lambdas s√©par√©es avec responsabilit√©s distinctes"
    - "Handlers minimalistes d√©l√©gant √† vectora_core"
    - "Aucune pollution par d√©pendances tierces"
    - "Configuration pilote enti√®rement le comportement"
    - "Modules partag√©s via Lambda Layers"
    - "Taille optimale (handlers < 20KB, layers < 50MB)"

# √âvolutions futures
roadmap:
  immediate:
    - "Compl√©ter impl√©mentation newsletter V2"
    - "Valider pipeline E2E complet"
  
  short_term:
    - "Tester migration Bedrock vers eu-west-3"
    - "√âvaluer mod√®le Sonnet 4.5"
    - "Optimiser parall√©lisation Bedrock"
  
  medium_term:
    - "Extension √† nouveaux clients/verticaux"
    - "Monitoring avanc√© et alertes"
    - "Optimisation co√ªts multi-clients"

metadata:
  version: "2.0"
  created_date: "2025-12-18"
  based_on: "Architecture V2 stabilis√©e et valid√©e E2E"
  replaces: "blueprint-draft-vectora-inbox.yaml (architecture V1 historique)"
  validation_docs:
    - "docs/diagnostics/src_v2_hygiene_audit_v2.md"
    - "docs/design/vectora_inbox_v2_engine_overview.md"
    - "docs/design/vectora_inbox_v2_bedrock_calls_map_lai_weekly_v3.md"
    - "docs/design/vectora_inbox_v2_blueprint_alignment_report.md"
  
  changelog:
    - version: "2.0"
      date: "2025-12-18"
      changes: "Cr√©ation blueprint V2 align√© sur architecture 3 Lambdas valid√©e"
      validation: "E2E sur lai_weekly_v3 - 15 items r√©els, 100% succ√®s"